# 项目代码文档
## 1. 项目结构
项目采用模块化结构，主要包含以下部分：

### 1.1 核心文件
- main.js : 游戏入口文件，初始化Phaser引擎和GameManager
- GameManager.js : 游戏管理器，整合所有游戏系统，提供统一接口管理游戏状态
### 1.2 场景系统
- scenes/MainMenuScene.js : 主菜单场景，游戏的第一个场景
- scenes/CharacterSelectScene.js : 角色选择场景，允许选择不同职业
- scenes/GameScene.js : 游戏主场景，包含游戏核心逻辑
### 1.3 角色系统
- classes/Character.js : 基础角色类，包含所有职业共有的属性和方法
- classes/Warrior.js : 战士职业，高攻高物防
- classes/Mage.js : 法师职业，高魔攻高魔防
- classes/Archer.js : 射手职业，高攻高速
### 1.4 敌人系统
- classes/Enemy.js : 敌人基类，包含AI状态机
- classes/enemies/ : 具体敌人类型实现
- classes/MysteriousStranger.js : 战士第一章的神秘人BOSS实现
- systems/EnemySystem.js : 敌人管理系统，负责生成和回收敌人
### 1.5 关卡系统
- LevelManager.js : 关卡管理器，负责管理多关卡数据和切换逻辑

### 1.6 其他系统
- systems/SkillSystem.js : 技能系统
- systems/ItemSystem.js : 物品系统
- systems/InventorySystem.js : 库存系统
- systems/SaveSystem.js : 存档系统
- systems/DialogueSystem.js : 对话系统，管理NPC对话界面和对话流程
- systems/QuestSystem.js : 任务系统，管理游戏中的任务和剧情进展
- systems/AwakeningSystem.js : 觉醒系统，管理角色的觉醒能力和状态

### 1.7 NPC和剧情系统
- classes/NPC.js : NPC类，包含交互范围检测、对话管理和任务相关功能
- data/DialogueData.js : 对话数据，定义各NPC的对话内容
- data/QuestData.js : 任务数据，定义游戏中的各种任务
- data/AwakeningData.js : 觉醒能力数据，定义各职业的觉醒能力
- scenes/NPCTestScene.js : NPC测试场景，用于测试对话、任务和觉醒功能
## 2. 代码设计逻辑
### 2.1 场景管理
项目使用Phaser的场景系统进行场景管理，主要场景流程为：

1. MainMenuScene (主菜单) → CharacterSelectScene (角色选择) → GameScene (游戏主场景)
每个场景都有标准的生命周期方法：

- preload() : 加载场景资源
- create() : 创建场景对象
- update() : 更新场景状态
### 2.2 游戏管理器
GameManager 作为核心管理类，负责：

- 管理游戏状态和玩家数据
- 整合各个子系统
- 处理场景切换
- 管理存档和读档
- 集成关卡管理器，处理关卡切换
- 管理NPC对话系统
  - 提供startDialogue方法，根据NPC对象和对话键名启动对话
  - 处理对话选项中的任务相关操作
  - 支持对话结束后的回调函数
- 管理任务系统和剧情进展
  - 提供updateObjective方法更新任务目标进度
  - 提供setQuestFlag方法设置任务标记
  - 提供setGameFlag方法设置游戏全局标记
  - 处理任务链和剧情线的推进
- 管理角色觉醒系统
  - 提供觉醒值的增减和觉醒状态的管理
  - 处理觉醒能力的解锁和激活
  - 在特定剧情点（如神秘人BOSS战）引入觉醒机制
### 2.3 角色系统
采用面向对象设计，通过继承实现不同职业特性：

- 基础 Character 类定义共有属性和方法
- 子类（如 Warrior 、 Mage 、 Archer ）实现特定职业的属性和技能
### 2.4 敌人AI系统
基于状态机模式实现敌人AI：

- 状态包括：闲置、巡逻、追击、攻击、受伤、死亡等
- 每个状态有对应的行为方法
- 根据条件在状态间切换
- 特殊Boss行为模式：
  - **神秘人Boss**：战士第一章的关键Boss，具有觉醒机制和强制剧情触发
  - **血量阈值触发**：当神秘人血量低于50%时触发觉醒
  - **剧情杀机制**：战斗结束时强制玩家失败，推进主线剧情
  - **实现细节**：
    - 继承自Enemy类，重写了update、attack、specialAttack、awaken、defeatPlayer、takeDamage和die方法
    - 觉醒机制：血量低于50%时触发awaken方法，增强属性和视觉效果
    - 剧情触发：通过defeatPlayer方法实现战斗结束后的剧情对话和场景切换
    - 任务进度：通过GameManager更新任务进度和设置任务标记
### 2.5 物品和掉落系统
- 基于概率的掉落机制
- 物品分类：装备、消耗品、材料
- 物品效果通过物品系统统一管理
## 3. 游戏基础设计
### 3.1 游戏类型
类银河战士恶魔城风格的2D动作冒险游戏

### 3.2 核心玩法
- 角色扮演与成长：三种职业选择，等级提升
- 技能系统：每个职业有4种特色技能
- 装备系统：提升角色属性
- 探索与战斗：探索地图，击败敌人
- 剧情系统：与NPC对话，完成任务，推进游戏剧情
- 觉醒系统：解锁和激活特殊觉醒能力，增强角色能力
### 3.3 交互设计
- 移动：方向键控制
- 攻击：空格键
- 技能：Q、W、E、R键
- 物品：数字键
- 存档：F5键
- 交互：E键（与NPC对话、触发事件等）
- 任务界面：J键
- 觉醒界面：K键
### 3.4 UI设计
- 生命条、魔法条、经验条
- 等级和职业显示
- 技能图标和冷却显示
- 物品栏和装备栏
- 对话UI：对话框、NPC名称、对话文本、对话选项
- 任务UI：当前任务列表、任务详情、任务目标进度
- 觉醒UI：已解锁觉醒能力、可解锁觉醒能力、觉醒能力详情

## 4. 多关卡场景实现

### 4.1 关卡管理器
LevelManager 负责管理游戏中的多个关卡，提供以下功能：

- 关卡数据配置：每个关卡包含地图、名称、难度、敌人类型、背景音乐等信息
- 关卡切换：支持前往下一关或指定关卡
- 关卡状态管理：跟踪当前关卡、检查是否为最后一关
- 关卡奖励：定义每个关卡完成后的经验、金币和物品奖励
- 关卡要求：设置进入关卡的等级要求

### 4.2 关卡切换机制

游戏中的关卡切换通过以下方式实现：

1. **传送门触发**：地图中放置特殊的传送门对象，玩家接触后触发关卡切换
2. **GameManager集成**：GameManager提供changeLevel方法，处理关卡切换逻辑
3. **玩家状态保存**：切换关卡时保存玩家状态，在新关卡中恢复
4. **场景过渡效果**：使用动画效果实现平滑的关卡切换体验

### 4.3 动态地图加载

GameScene支持动态加载不同关卡的地图：

1. 初始化时从关卡数据获取地图路径
2. 根据关卡数据创建相应的地图和图层
3. 从地图对象层获取敌人、传送门等交互对象的位置
4. 设置当前位置信息，用于存档和读档

## 5. 游戏系统实现

### 5.1 NPC对话系统

DialogueSystem 负责管理游戏中的NPC对话，提供以下功能：

- 对话UI创建：包括对话框背景、NPC名称文本、对话内容文本、继续提示和选项按钮
- 对话流程控制：开始对话、继续对话、结束对话
- 对话选项：支持多选项对话，根据玩家选择影响对话走向
- 对话触发：支持触发任务、给予物品等游戏事件
- 对话状态管理：跟踪当前对话进度，支持条件性对话

对话数据通过 DialogueData.js 定义，包含以下结构：

- NPC ID：唯一标识NPC
- 对话类型：默认对话、任务相关对话、特殊事件对话
- 对话内容：文本内容、说话者、选项
- 条件：触发特定对话的条件（如任务状态、游戏标志等）

### 5.2 任务系统

QuestSystem 负责管理游戏中的任务和剧情进展，提供以下功能：

- 任务管理：开始任务、更新任务目标、完成任务
- 任务状态跟踪：未接受、进行中、已完成、失败
- 任务目标：支持多种目标类型（收集物品、击败敌人、与NPC对话等）
- 任务奖励：经验、金币、物品、解锁新区域等
- 任务链：支持任务之间的前置和后续关系，形成剧情线
- 任务UI：显示当前任务、任务描述、任务目标进度

任务数据通过 QuestData.js 定义，包含以下结构：

- 任务ID：唯一标识任务
- 任务标题和描述：任务的名称和详细描述
- 任务类型：主线任务、支线任务、隐藏任务、职业特定任务
- 任务给予者：哪个NPC给予该任务
- 任务位置：任务发生的地点
- 前置条件：接受任务所需的条件（如等级、已完成的任务等）
- 任务目标：需要完成的具体目标
- 任务奖励：完成任务后获得的奖励
- 后续任务：完成当前任务后解锁的下一个任务

### 5.3 觉醒系统

AwakeningSystem 负责管理角色的觉醒能力和状态，提供以下功能：

- 觉醒能力管理：解锁、激活、停用觉醒能力
- 觉醒条件检查：检查解锁觉醒能力的条件是否满足
- 觉醒效果应用：应用觉醒能力的被动和主动效果
- 觉醒冷却管理：管理觉醒能力的冷却时间
- 觉醒状态保存：保存和加载觉醒系统状态
- 觉醒UI：显示已解锁和可解锁的觉醒能力
- 觉醒值系统：通过战斗积累觉醒值，达到阈值后可进入觉醒状态
- 觉醒状态管理：进入和退出觉醒状态，应用和移除觉醒增益效果

觉醒能力数据通过 AwakeningData.js 定义，包含以下结构：

- 能力ID：唯一标识觉醒能力
- 能力名称和描述：觉醒能力的名称和详细描述
- 所需职业：哪个职业可以使用该觉醒能力
- 所需等级：解锁该觉醒能力所需的最低等级
- 前置条件：解锁该觉醒能力所需的其他觉醒能力
- 解锁条件：解锁该觉醒能力所需满足的游戏条件
- 被动效果：觉醒能力提供的持续性效果
- 主动效果：觉醒能力提供的可触发效果
- 消耗：使用觉醒能力所需的资源（如魔法值）
- 持续时间：觉醒能力效果的持续时间
- 冷却时间：觉醒能力的冷却时间
- 觉醒等级：觉醒能力的等级，影响效果强度

### 5.4 系统集成

以上三个系统（对话系统、任务系统、觉醒系统）通过GameManager进行集成，实现以下功能：

- 对话触发任务：通过对话系统触发任务系统的任务开始、更新和完成
- 任务解锁觉醒：完成特定任务后解锁觉醒能力
- 觉醒影响对话：角色的觉醒状态影响NPC对话内容
- 剧情推进：通过任务完成和对话选择推进游戏剧情
- GameManager 初始化这些系统并提供统一的接口
- 系统状态作为游戏状态的一部分进行保存和加载
- 系统之间相互关联：对话可以触发任务，任务可以解锁觉醒能力
- NPCTestScene 提供了测试这些系统的专用场景

## 6. 游戏剧情系统
剧情大纲：背景发生在某个王国，共有ABC三个主区域与1个王国，战士出生在A区域的一个部落，背景是一个英勇强大的战士，法师出生在B区域的一个魔法密林，背景是一个年轻天赋异禀的魔法师，射手 出生在C区域的一个小村庄，背景是身世悲惨的孤儿，因为没饭吃学会打猎充饥成了神箭手2.不同职业经历的冒险，地图，怪物等都不同，但主线剧情都是主角因为某种契机发现觉醒力量的存在，踏上寻找觉醒力量的旅程（第1章），之后经过一段冒险学会了觉醒，同时发现了王国区域的暗流涌动-反叛势力，反叛势力有诸多将领，每个将领都有觉醒能力（战士第一章神秘人就是将领一员），并前往王国支援 

### 6.1 战士第一章任务线

战士第一章包含以下主线任务：

1. **一个平凡的日子**：完成部落的狩猎仪式，击杀野猪和击败猪王
2. **神秘入侵者**：调查并阻止在村庄附近出现的神秘人
   - 关键剧情点：与神秘人的战斗是一场必败的战斗，通过剧情杀推进故事
   - 神秘人BOSS特性：血量低于50%时觉醒，拥有强大的攻击能力
   - 战斗结果：玩家被击败，但获得了关于觉醒力量的线索
3. **觉醒的秘密**：向部落酋长寻求关于觉醒力量的知识
4. **觉醒之路**：离开部落，前往小城寻找了解觉醒能力的老者

这一任务线通过剧情引导玩家了解游戏的核心机制——觉醒系统，并为后续章节的故事发展奠定基础。